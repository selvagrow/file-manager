<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R2 File Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #4f46e5;
      --primary-hover: #4338ca;
      --gray-light: #f3f4f6;
      --gray-text: #6b7280;
    }
    .drag-active {
      border-color: var(--primary-color);
      background-color: rgba(79, 70, 229, 0.05);
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    .toast {
      animation: slide-in 0.3s ease-out, fade-out 0.5s ease-in forwards;
      animation-delay: 0s, 3.5s;
    }
    .filter-btn.active {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    .filter-btn.active span {
      background-color: white;
      color: var(--primary-color);
    }
    .file-card {
      transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    }
    .file-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    #image-preview-modal {
      background-color: rgba(0,0,0,0.8);
      transition: opacity 0.3s ease;
    }
    #preview-image {
      transition: transform 0.3s ease;
      cursor: zoom-in;
    }
    /* --- ADDED FOR FAB --- */
    #fabUpload {
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    /* --- END ADDED --- */

    @keyframes slide-in {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fade-out {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
  <div id="toast-container" class="fixed bottom-5 right-5 z-[100] flex flex-col gap-3"></div>

  <div id="image-preview-modal" class="fixed inset-0 z-[90] flex items-center justify-center p-4 hidden opacity-0">
    <div class="relative max-w-4xl max-h-full">
      <img id="preview-image" src="" alt="Image Preview" class="rounded-lg shadow-2xl max-w-full max-h-[80vh]">
      <div id="preview-info" class="text-white text-sm absolute bottom-2 left-2 bg-black bg-opacity-50 px-2 py-1 rounded"></div>
      <button id="close-preview-btn" class="absolute -top-2 -right-2 bg-white text-black rounded-full h-8 w-8 flex items-center justify-center shadow-lg hover:bg-gray-200 transition-transform transform hover:scale-110">
        <i class="fas fa-times"></i>
      </button>
      <div class="absolute top-2 left-2 flex gap-2">
        <button id="zoom-in-btn" class="bg-white text-black rounded-full h-8 w-8 flex items-center justify-center shadow-lg hover:bg-gray-200 transition-transform transform hover:scale-110"><i class="fas fa-search-plus"></i></button>
        <button id="zoom-out-btn" class="bg-white text-black rounded-full h-8 w-8 flex items-center justify-center shadow-lg hover:bg-gray-200 transition-transform transform hover:scale-110"><i class="fas fa-search-minus"></i></button>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-3 sm:px-4 md:px-8 py-6 max-w-7xl">
    <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center">
      <div>
          <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-1 flex items-center">
            <i class="fas fa-cloud-upload-alt mr-3 text-indigo-600"></i>
            Qiblat File Manager
          </h1>
          <p class="text-gray-600">Drag, drop, and manage your files with ease.</p>
      </div>
      <div class="flex items-center gap-2 sm:gap-4 mt-4 md:mt-0">
        <div 
          id="dropArea" 
          class="border-2 border-dashed border-gray-300 rounded-lg p-3 text-center cursor-pointer transition-all hover:border-indigo-500 hover:bg-indigo-50"
        >
          <input type="file" id="fileInput" class="hidden" multiple>
          <button id="browseButton" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold">
            <i class="fas fa-folder-open mr-2"></i> Upload
          </button>
        </div>
        <a href="/api-docs.html" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors text-sm font-semibold" title="API Documentation">
          <i class="fas fa-code"></i> API
        </a>
         <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold" title="Logout">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <div id="uploadProgressContainer" class="mb-6 space-y-2"></div>

    <div class="bg-white rounded-lg shadow-sm p-4 mb-6 sticky top-0 z-10">
      <div class="flex flex-col md:flex-row gap-4 justify-between">
        <div class="flex items-center flex-wrap gap-2">
            <button data-filter="all" class="filter-btn active text-xs sm:text-sm px-3 py-1.5 sm:px-4 sm:py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors flex items-center gap-1">All <span id="countAll" class="ml-1 bg-gray-400 text-white rounded-full px-2 text-xs font-bold">0</span></button>
            <button data-filter="image" class="filter-btn text-xs sm:text-sm px-3 py-1.5 sm:px-4 sm:py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors flex items-center gap-1"><i class="fas fa-image mr-1 sm:mr-2"></i>Images <span id="countImage" class="ml-1 bg-gray-300 text-gray-700 rounded-full px-2 text-xs font-bold">0</span></button>
            <button data-filter="doc" class="filter-btn text-xs sm:text-sm px-3 py-1.5 sm:px-4 sm:py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors flex items-center gap-1"><i class="fas fa-file-alt mr-1 sm:mr-2"></i>Docs <span id="countDoc" class="ml-1 bg-gray-300 text-gray-700 rounded-full px-2 text-xs font-bold">0</span></button>
            <button data-filter="audio" class="filter-btn text-xs sm:text-sm px-3 py-1.5 sm:px-4 sm:py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors flex items-center gap-1"><i class="fas fa-music mr-1 sm:mr-2"></i>Audio <span id="countAudio" class="ml-1 bg-gray-300 text-gray-700 rounded-full px-2 text-xs font-bold">0</span></button>
            <button data-filter="video" class="filter-btn text-xs sm:text-sm px-3 py-1.5 sm:px-4 sm:py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors flex items-center gap-1"><i class="fas fa-video mr-1 sm:mr-2"></i>Video <span id="countVideo" class="ml-1 bg-gray-300 text-gray-700 rounded-full px-2 text-xs font-bold">0</span></button>
            <button data-filter="archive" class="filter-btn text-xs sm:text-sm px-3 py-1.5 sm:px-4 sm:py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors flex items-center gap-1"><i class="fas fa-file-archive mr-1 sm:mr-2"></i>Archives <span id="countArchive" class="ml-1 bg-gray-300 text-gray-700 rounded-full px-2 text-xs font-bold">0</span></button>
        </div>
        <div class="flex gap-2">
            <div class="relative flex-grow">
                <input type="text" id="searchInput" placeholder="Search files..." class="w-full py-2 pl-10 pr-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <button id="refreshBtn" class="p-2 w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-300 hover:bg-gray-100" title="Refresh files">
                <i class="fas fa-sync-alt text-indigo-600"></i>
            </button>
        </div>
      </div>
    </div>
    
    <div id="filesGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-5 gap-3 md:gap-4 lg:gap-6">
      <div id="loading-indicator" class="col-span-full text-center py-16 text-gray-500">
        <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
        <p>Loading files, please wait...</p>
      </div>
    </div>
    <div id="empty-state" class="col-span-full text-center py-16 text-gray-500 hidden">
        <i class="fas fa-folder-open text-5xl mb-4"></i>
        <p class="text-xl">No files found.</p>
        <p>Try changing your search or filter.</p>
    </div>
    
    <div id="pagination-controls" class="text-center mt-8">
      <button id="loadMoreBtn" class="bg-white text-indigo-600 font-semibold px-6 py-3 rounded-full shadow-md hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed hidden">
        Load More Files
      </button>
    </div>

  </div>

  <button id="fabUpload" class="hidden md:hidden fixed bottom-6 right-6 bg-indigo-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-indigo-700 z-40 transform scale-0 opacity-0" title="Upload Files">
    <i class="fas fa-plus text-xl"></i>
  </button>

  <div id="share-popover" class="hidden absolute z-50 bg-white rounded-lg shadow-xl border border-gray-200 p-2 flex flex-col gap-1 min-w-[200px]">
      <button id="copy-cdn-btn" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md flex items-center gap-2">
        <i class="fas fa-link fa-fw"></i> Copy Public URL
      </button>
      <button id="copy-presigned-btn" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md flex items-center gap-2">
        <i class="fas fa-user-clock fa-fw"></i> Copy Temporary URL
      </button>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- STATE MANAGEMENT ---
      let allFiles = [];
      let nextToken = null;
      let isLoading = false;
      let currentFilter = 'all';
      let currentSearchTerm = '';
      let activeUploads = 0;
      let currentZoom = 1;

      // --- DOM ELEMENTS ---
      const dropArea = document.getElementById('dropArea');
      const fileInput = document.getElementById('fileInput');
      const browseButton = document.getElementById('browseButton');
      const logoutBtn = document.getElementById('logoutBtn');
      const uploadProgressContainer = document.getElementById('uploadProgressContainer');
      const filesGrid = document.getElementById('filesGrid');
      const loadingIndicator = document.getElementById('loading-indicator');
      const emptyState = document.getElementById('empty-state');
      const refreshBtn = document.getElementById('refreshBtn');
      const searchInput = document.getElementById('searchInput');
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      const filterButtons = document.querySelectorAll('.filter-btn');
      
      // --- ADDED: New DOM Elements ---
      const fabUpload = document.getElementById('fabUpload');
      const sharePopover = document.getElementById('share-popover');
      const copyCdnBtn = document.getElementById('copy-cdn-btn');
      const copyPresignedBtn = document.getElementById('copy-presigned-btn');

      // Image Preview Modal Elements
      const previewModal = document.getElementById('image-preview-modal');
      const previewImage = document.getElementById('preview-image');
      const previewInfo = document.getElementById('preview-info');
      const closePreviewBtn = document.getElementById('close-preview-btn');
      const zoomInBtn = document.getElementById('zoom-in-btn');
      const zoomOutBtn = document.getElementById('zoom-out-btn');

      // --- UTILITY FUNCTIONS ---
      const formatFileSize = (bytes) => {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
      };

      const getFileIcon = (ext) => {
        const icons = {
          'pdf': 'fa-file-pdf', 'doc': 'fa-file-word', 'docx': 'fa-file-word',
          'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel', 'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint',
          'mp3': 'fa-file-audio', 'wav': 'fa-file-audio', 'ogg': 'fa-file-audio',
          'mp4': 'fa-file-video', 'mov': 'fa-file-video', 'avi': 'fa-file-video',
          'zip': 'fa-file-archive', 'rar': 'fa-file-archive', '7z': 'fa-file-archive',
          'txt': 'fa-file-alt', 'json': 'fa-file-code', 'js': 'fa-file-code', 'html': 'fa-file-code'
        };
        return icons[ext] || 'fa-file';
      };

      const showToast = (type, message) => {
          const toastContainer = document.getElementById('toast-container');
          const toast = document.createElement('div');
          const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
          const colors = { success: 'green', error: 'red', info: 'blue' };
          toast.className = `toast shadow-lg rounded-lg p-4 flex items-center max-w-sm w-full bg-white border-l-4 border-${colors[type]}-500`;
          toast.innerHTML = `<i class="fas ${icons[type]} mr-3 text-${colors[type]}-500 text-xl"></i> <span class="text-gray-700">${message}</span>`;
          toastContainer.appendChild(toast);
          setTimeout(() => toast.remove(), 4000);
      };

      const debounce = (func, wait) => {
          let timeout;
          return function executedFunction(...args) {
              const later = () => {
                  clearTimeout(timeout);
                  func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
          };
      };

      // Wrapper for fetch API to handle 401 Unauthorized errors
      async function authenticatedFetch(url, options = {}) {
          // Set credentials to include cookies
          const fetchOptions = {
              ...options,
              credentials: 'include'
          };
          
          const response = await fetch(url, fetchOptions);
          
          if (response.status === 401) {
              // Try to refresh token
              try {
                  const refreshResponse = await fetch('/auth/refresh', {
                      method: 'POST',
                      credentials: 'include'
                  });
                  
                  if (refreshResponse.ok) {
                      // Token refreshed, retry original request
                      return await fetch(url, fetchOptions);
                  }
              } catch (refreshError) {
                  // Refresh failed, redirect to login
              }
              
              // Redirect to login if token refresh fails
              window.location.href = '/auth/login';
              throw new Error('Unauthorized');
          }
          
          return response;
      }

      // --- FILE FETCHING AND RENDERING ---
      async function loadFiles(loadMore = false) {
          if (isLoading) return;
          isLoading = true;
          if (!loadMore) {
              loadingIndicator.classList.remove('hidden');
              emptyState.classList.add('hidden');
              filesGrid.innerHTML = ''; // Clear grid for new content or loader
              filesGrid.appendChild(loadingIndicator);
          }
          loadMoreBtn.disabled = true;

          try {
              let url = `/r2/files?limit=30&prefix=${encodeURIComponent(currentSearchTerm)}`;
              if (loadMore && nextToken) url += `&token=${encodeURIComponent(nextToken)}`;
              
              const response = await authenticatedFetch(url);
              if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch');
              
              const data = await response.json();
              if (!loadMore) {
                allFiles = data.files || [];
              } else {
                allFiles = allFiles.concat(data.files || []);
              }
              nextToken = data.nextToken;
              
              renderFiles();
              
              loadMoreBtn.classList.toggle('hidden', !nextToken);
          } catch (err) {
              if (err.message !== 'Unauthorized') {
                showToast('error', `Failed to load files: ${err.message}`);
                filesGrid.innerHTML = ''; // Clear loader
                emptyState.classList.remove('hidden');
                filesGrid.appendChild(emptyState);
              }
          } finally {
              isLoading = false;
              loadMoreBtn.disabled = false;
          }
      }

      function renderFiles() {
          const grid = document.createDocumentFragment();

          // Update filter badge counts
          const typeCounts = { all: 0, image: 0, doc: 0, audio: 0, video: 0, archive: 0 };
          const typesDef = {
              image: ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'],
              doc: ['pdf', 'doc', 'docx', 'txt', 'xls', 'xlsx', 'ppt', 'pptx'],
              audio: ['mp3', 'wav', 'ogg'],
              video: ['mp4', 'mov', 'avi', 'webm'],
              archive: ['zip', 'rar', '7z']
          };

          allFiles.forEach(f => {
            typeCounts.all++;
            const ext = f.key.split('.').pop().toLowerCase();
            for (const type in typesDef) {
                if (typesDef[type].includes(ext)) {
                    typeCounts[type]++;
                    break;
                }
            }
          });
          document.getElementById('countAll').textContent = typeCounts.all;
          document.getElementById('countImage').textContent = typeCounts.image;
          document.getElementById('countDoc').textContent = typeCounts.doc;
          document.getElementById('countAudio').textContent = typeCounts.audio;
          document.getElementById('countVideo').textContent = typeCounts.video;
          document.getElementById('countArchive').textContent = typeCounts.archive;

          // Filter files based on the current active filter
          const filteredFiles = allFiles.filter(file => {
            if (currentFilter === 'all') return true;
            const ext = file.key.split('.').pop().toLowerCase();
            return typesDef[currentFilter]?.includes(ext);
          });
          
          filesGrid.innerHTML = ''; // Clear grid (removes loader or previous files)
          
          if(filteredFiles.length === 0 && !isLoading){
            emptyState.classList.remove('hidden');
            filesGrid.appendChild(emptyState);
          } else {
            emptyState.classList.add('hidden');
          }

          filteredFiles.forEach(file => {
              const originalName = file.key.includes('-') ? file.key.substring(file.key.indexOf('-') + 1) : file.key;
              const fileExt = originalName.split('.').pop().toLowerCase();
              const isImage = typesDef.image.includes(fileExt);
              const publicUrl = file.url || `/r2/download/${encodeURIComponent(file.key)}`;
              
              const card = document.createElement('div');
              card.className = 'file-card bg-white rounded-xl shadow-lg overflow-hidden flex flex-col border border-gray-200/80';

              // --- Thumbnail Section ---
              const thumbWrap = document.createElement('div');
              thumbWrap.className = 'relative h-32 md:h-40 bg-slate-100';
              const badge = `<div class="absolute top-2.5 right-2.5 bg-black/40 text-white text-[10px] font-bold px-2 py-0.5 rounded-md uppercase">${fileExt}</div>`;

              if (isImage) {
                  thumbWrap.innerHTML = `
                      <img src="${publicUrl}" alt="${originalName}" class="w-full h-full object-cover" loading="lazy" style="cursor:pointer;">
                      ${badge}
                  `;
                  thumbWrap.querySelector('img').onclick = () => openImagePreview(publicUrl, file);
              } else {
                  const iconColorMap = {
                      'pdf': 'text-red-500', 'doc': 'text-blue-500', 'docx': 'text-blue-500',
                      'xls': 'text-green-500', 'xlsx': 'text-green-500', 'ppt': 'text-orange-500', 'pptx': 'text-orange-500',
                      'mp3': 'text-purple-500', 'wav': 'text-purple-500', 'mp4': 'text-indigo-500',
                      'zip': 'text-yellow-600', 'rar': 'text-yellow-600'
                  };
                  const iconColor = iconColorMap[fileExt] || 'text-gray-500';
                  thumbWrap.innerHTML = `
                      <div class="w-full h-full flex items-center justify-center">
                          <i class="fas ${getFileIcon(fileExt)} text-5xl md:text-6xl ${iconColor} opacity-70"></i>
                      </div>
                      ${badge}
                  `;
              }
              card.appendChild(thumbWrap);

              // --- Content Section (Info + Actions) ---
              const contentDiv = document.createElement('div');
              contentDiv.className = 'p-3 flex flex-col flex-grow';
              // CHANGED: Added data-url to copy button
              contentDiv.innerHTML = `
                  <p class="font-bold text-sm text-gray-900 truncate" title="${originalName}">${originalName}</p>
                  <p class="text-xs text-gray-500 mt-1">${formatFileSize(file.size)} &bull; ${new Date(file.lastModified).toLocaleDateString('en-CA')}</p>
                  <div class="flex-grow"></div>
                  <div class="flex items-center gap-2 mt-3">
                      <a href="/r2/download/${encodeURIComponent(file.key)}" download class="download-btn flex-1 bg-indigo-50 text-indigo-600 font-semibold rounded-lg flex items-center justify-center h-9 sm:gap-2 sm:px-3 hover:bg-indigo-100 transition-colors">
                          <i class="fas fa-download text-sm"></i>
                          <span class="hidden sm:inline text-sm">Download</span>
                      </a>
                      <button class="action-btn copy-url-btn bg-green-50 text-green-600 rounded-lg w-9 h-9 flex-shrink-0 flex items-center justify-center hover:bg-green-100 transition-colors" data-key="${file.key}" data-url="${publicUrl}" title="Share File">
                          <i class="fas fa-share-alt"></i>
                      </button>
                      <button class="action-btn delete-btn bg-red-50 text-red-600 rounded-lg w-9 h-9 flex-shrink-0 flex items-center justify-center hover:bg-red-100 transition-colors" data-key="${file.key}" title="Delete">
                          <i class="fas fa-trash"></i>
                      </button>
                  </div>
              `;
              card.appendChild(contentDiv);
              grid.appendChild(card);
          });
          
          filesGrid.appendChild(grid);
          addFileActionListeners();
      }


      function addFileActionListeners() {
          document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = (e) => handleDelete(e.currentTarget.dataset.key));
          // CHANGED: Pass the whole event to handleCopyUrl
          document.querySelectorAll('.copy-url-btn').forEach(btn => btn.onclick = (e) => handleCopyUrl(e));
      }
      
      async function handleDelete(key) {
        if (!confirm(`Are you sure you want to delete this file? This action cannot be undone.`)) return;
        try {
            const res = await authenticatedFetch(`/r2/files/${key}`, { method: 'DELETE' });
            if (!res.ok) throw new Error((await res.json()).error || 'Failed');
            showToast('success', 'File deleted successfully.');
            allFiles = allFiles.filter(f => f.key !== key);
            renderFiles();
        } catch (err) {
             if (err.message !== 'Unauthorized') {
                showToast('error', `Delete failed: ${err.message}`);
             }
        }
      }

      // --- CHANGED: Completely new function to handle share popover ---
      // --- CHANGED: Completely new function to handle share popover ---
      function handleCopyUrl(event) {
          event.stopPropagation(); // Prevent document click listener from firing immediately
          const buttonEl = event.currentTarget;
          const fileKey = buttonEl.dataset.key;
          const cdnUrl = buttonEl.dataset.url;

          const popover = sharePopover;
          const hidePopover = () => {
              popover.classList.add('hidden');
              // Hapus style yang ditambahkan agar tidak mengganggu perhitungan berikutnya
              popover.style.left = '';
              popover.style.top = '';
              popover.style.visibility = '';
              document.removeEventListener('click', hidePopover);
          };
          
          // --- START: Logic Perbaikan Responsif ---
          const rect = buttonEl.getBoundingClientRect();
          const margin = 8; // Jarak antara tombol dan popover, serta popover dan tepi layar

          // Buat popover terlihat tetapi tersembunyi untuk mendapatkan lebar yang akurat tanpa berkedip
          popover.style.visibility = 'hidden';
          popover.classList.remove('hidden');
          const popoverWidth = popover.offsetWidth;

          // Posisi default: ratakan tepi kanan
          let leftPos = rect.right - popoverWidth;
          let topPos = rect.bottom + margin;

          // Koreksi jika keluar dari batas kanan viewport
          if (leftPos + popoverWidth > window.innerWidth - margin) {
              leftPos = window.innerWidth - popoverWidth - margin;
          }

          // Koreksi jika keluar dari batas kiri viewport
          if (leftPos < margin) {
              leftPos = margin;
          }

          // Terapkan posisi akhir (tambahkan offset scroll untuk positioning absolut)
          popover.style.left = `${leftPos + window.scrollX}px`;
          popover.style.top = `${topPos + window.scrollY}px`;
          
          // Sekarang buat benar-benar terlihat
          popover.style.visibility = 'visible';
          // --- END: Logic Perbaikan Responsif ---


          // Tambahkan listener untuk menutup popover saat mengklik di tempat lain
          setTimeout(() => document.addEventListener('click', hidePopover), 0);
          
          // Pasang listener sekali pakai ke tombol popover
          copyCdnBtn.onclick = () => {
              navigator.clipboard.writeText(cdnUrl);
              showToast('success', 'Public URL disalin!');
              hidePopover();
          };

          copyPresignedBtn.onclick = async () => {
              const icon = copyPresignedBtn.querySelector('i');
              icon.classList.add('fa-spin');
              try {
                  const res = await authenticatedFetch(`/r2/presigned/${fileKey}?expires=86400`); // link 24 jam
                  if (!res.ok) throw new Error((await res.json()).error || 'Gagal');
                  const { url } = await res.json();
                  navigator.clipboard.writeText(url);
                  showToast('success', 'Temporary URL disalin!');
              } catch(err) {
                  if (err.message !== 'Unauthorized') {
                      showToast('error', `Tidak bisa mendapatkan URL: ${err.message}`);
                  }
              } finally {
                  icon.classList.remove('fa-spin');
                  hidePopover();
              }
          };

          popover.onclick = (e) => e.stopPropagation(); // Mencegah klik di dalam popover menutupnya
      }

      // --- FILE UPLOAD ---
      function setupUploadListeners() {
        browseButton.onclick = () => fileInput.click();
        // ADDED: Floating button click listener
        fabUpload.onclick = () => fileInput.click();

        fileInput.onchange = (e) => handleFiles(e.target.files);
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, e => {
          e.preventDefault(); e.stopPropagation();
        }, false));
        ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-active')));
        ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-active')));
        dropArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
      }

      function handleFiles(files) {
        [...files].forEach(uploadFile);
      }

      function uploadFile(file) {
          const uploadId = `upload-${Date.now()}-${Math.random()}`;
          const progressElement = document.createElement('div');
          progressElement.id = uploadId;
          progressElement.className = 'bg-white p-3 rounded-lg shadow-sm';
          progressElement.innerHTML = `
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm font-medium text-gray-700 truncate w-4/5">${file.name}</span>
              <span class="text-sm font-medium text-gray-700">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-indigo-600 h-2 rounded-full progress-bar" style="width: 0%"></div>
            </div>
          `;
          uploadProgressContainer.appendChild(progressElement);

          const formData = new FormData();
          formData.append('file', file);
          const xhr = new XMLHttpRequest();
          xhr.open('POST', '/r2/upload', true);
          
          xhr.upload.onprogress = (e) => {
              if (e.lengthComputable) {
                  const percent = Math.round((e.loaded / e.total) * 100);
                  progressElement.querySelector('.progress-bar').style.width = `${percent}%`;
                  progressElement.querySelector('span:last-child').textContent = `${percent}%`;
              }
          };
          
          xhr.onload = () => {
              if (xhr.status === 401) {
                  window.location.href = '/login';
                  return;
              }

              if (xhr.status >= 200 && xhr.status < 300) {
                  showToast('success', `${file.name} uploaded.`);
                  progressElement.querySelector('.progress-bar').classList.replace('bg-indigo-600', 'bg-green-500');
                  loadFiles(); // Refresh list after upload
              } else {
                  const errorMsg = JSON.parse(xhr.responseText).error || 'Upload failed';
                  showToast('error', errorMsg);
                   progressElement.querySelector('.progress-bar').classList.replace('bg-indigo-600', 'bg-red-500');
              }
              setTimeout(() => progressElement.remove(), 3000);
          };
          xhr.onerror = () => {
            showToast('error', 'Network error during upload.');
            progressElement.remove();
          }

          xhr.send(formData);
      }
      
      // --- IMAGE PREVIEW MODAL ---
      function openImagePreview(url, file) {
        currentZoom = 1;
        previewImage.style.transform = `scale(1)`;
        previewImage.src = url;
        previewImage.dataset.naturalWidth = '...';
        previewImage.dataset.naturalHeight = '...';

        const img = new Image();
        img.onload = () => {
          previewImage.dataset.naturalWidth = img.naturalWidth;
          previewImage.dataset.naturalHeight = img.naturalHeight;
          updatePreviewInfo(file);
        };
        img.src = url;

        previewModal.classList.remove('hidden');
        setTimeout(() => previewModal.classList.add('opacity-100'), 10);
      }
      
      function closeImagePreview() {
        previewModal.classList.remove('opacity-100');
        setTimeout(() => previewModal.classList.add('hidden'), 300);
      }

      function updatePreviewInfo(file) {
        const { naturalWidth, naturalHeight } = previewImage.dataset;
        previewInfo.textContent = `${naturalWidth} x ${naturalHeight}px • ${formatFileSize(file.size)}`;
      }

      function setupPreviewListeners() {
        closePreviewBtn.onclick = closeImagePreview;
        previewModal.onclick = (e) => { if (e.target === previewModal) closeImagePreview() };
        zoomInBtn.onclick = () => { currentZoom = Math.min(3, currentZoom + 0.2); previewImage.style.transform = `scale(${currentZoom})`};
        zoomOutBtn.onclick = () => { currentZoom = Math.max(0.5, currentZoom - 0.2); previewImage.style.transform = `scale(${currentZoom})`};
        previewImage.onclick = () => {
            if(previewImage.style.cursor === 'zoom-in') {
                previewImage.style.cursor = 'zoom-out';
                currentZoom = 2;
            } else {
                previewImage.style.cursor = 'zoom-in';
                currentZoom = 1;
            }
            previewImage.style.transform = `scale(${currentZoom})`;
        };
      }


      // --- EVENT LISTENERS INITIALIZATION ---
      async function handleLogout() {
          try {
              const response = await fetch('/auth/logout', { 
                  method: 'POST',
                  credentials: 'include'
              });
              
              if (response.ok) {
                  showToast('success', 'Logged out successfully');
                  setTimeout(() => {
                      window.location.href = '/auth/login';
                  }, 1000);
              } else {
                  throw new Error('Logout request failed');
              }
          } catch (err) {
              console.error('Logout error:', err);
              showToast('error', 'Logout failed. Please try again.');
              // Force redirect anyway
              setTimeout(() => {
                  window.location.href = '/auth/login';
              }, 2000);
          }
      }
      
      // --- ADDED: Intersection Observer for FAB ---
      function setupFabObserver() {
          const observer = new IntersectionObserver((entries) => {
              const entry = entries[0];
              if (entry.isIntersecting) {
                  // Header upload button is visible, hide FAB
                  fabUpload.classList.add('scale-0', 'opacity-0');
                  setTimeout(() => fabUpload.classList.add('hidden'), 300);
              } else {
                  // Header upload button is not visible, show FAB
                  fabUpload.classList.remove('hidden');
                  setTimeout(() => fabUpload.classList.remove('scale-0', 'opacity-0'), 10);
              }
          }, { threshold: 0 });

          observer.observe(dropArea);
      }

      function init() {
        setupUploadListeners();
        setupPreviewListeners();
        setupFabObserver(); // ADDED
        logoutBtn.onclick = handleLogout;

        refreshBtn.onclick = () => {
          currentSearchTerm = '';
          searchInput.value = '';
          loadFiles();
        };

        searchInput.oninput = debounce(() => {
          currentSearchTerm = searchInput.value.trim();
          loadFiles();
        }, 500);

        filterButtons.forEach(btn => {
          btn.onclick = () => {
            filterButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            renderFiles();
          };
        });
        loadMoreBtn.onclick = () => loadFiles(true);
        
        loadFiles();
      }

      init();
    });
  </script>
</body>
</html>